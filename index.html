<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>英語学習（範囲UI＋ASR・安定改良版）</title>
  <!-- ★ PWA 追加 -->
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192.png">
  <link rel="stylesheet" href="styles/app.css">
  <meta name="theme-color" content="#0b0e1a" />
</head>
<body>
<div id="loadingOverlay" role="presentation" aria-hidden="true">
  <div class="loaderAura">
    <div class="loaderRing"></div>
    <div class="loaderCore"></div>
    <div class="loaderDots" aria-hidden="true"><span></span><span></span><span></span></div>
  </div>
</div>
<div id="dirPermOverlay" hidden aria-hidden="true">
  <div id="dirPermBox" role="dialog" aria-modal="true" aria-labelledby="dirPermTitle">
    <h2 id="dirPermTitle">音声フォルダへのアクセス許可が必要です</h2>
    <p>保存済みの音声フォルダにアクセスするには、端末のダイアログで「許可する」を選んでください。アクセスを許可しない場合、音声が再生できないことがあります。</p>
    <div id="dirPermStatus" aria-live="polite"></div>
    <div class="actions">
      <button id="dirPermLater" class="btn" hidden>許可せず続行</button>
      <button id="dirPermAllow" class="btn ok">許可を開く</button>
    </div>
  </div>
</div>
<div id="app">
  <header>
    <div class="stat">
      <span class="stat-main" id="statSection">—</span>
    </div>
    <div class="stat">
      <span class="stat-sub">Lv</span>
      <span class="stat-main" id="statLevelAvg">—</span>
    </div>
    <div class="stat">
      <span class="stat-main" id="statProgressCurrent">0</span>
      <span class="stat-sub">/</span>
      <span class="stat-main" id="statProgressTotal">0</span>
    </div>
    <div class="grow"></div>
    <button id="btnCfg" class="icon-btn" type="button" aria-label="設定を開く" title="設定">⚙️</button>
  </header>

  <!-- 出題範囲（ネイティブピッカー） -->
  <div id="rangeBar">
    <div class="range-item">
      <label class="sr-only" for="secSel">セクション</label>
      <select id="secSel" aria-label="セクション選択"></select>
    </div>
    <div class="range-item">
      <span class="sr-only" id="levelFilterLabel">レベル</span>
      <div id="levelFilter" class="level-filter" role="group" aria-labelledby="levelFilterLabel"></div>
    </div>
    <div class="range-item">
      <label class="sr-only" for="orderSel">並び</label>
      <select id="orderSel" aria-label="並び順">
        <option value="asc">昇順</option>
        <option value="rnd">ランダム</option>
      </select>
    </div>
    <div class="range-item">
      <label class="sr-only" for="rangeSearch">検索</label>
      <div class="search-input">
        <input id="rangeSearch" type="search" placeholder="単語検索" autocomplete="off" />
      </div>
    </div>
  </div>

  <main>
    <section class="card" id="card" aria-live="polite">
      <div class="chips" id="chips"></div>
      <div id="enText" class="en">出題を準備しています…（ダブルタップで和訳）</div>
      <div id="jaText" class="ja">—</div>
      <div id="composeGuide" class="compose-guide" aria-hidden="true">
        <h4>並び替えガイド</h4>
        <p id="composeNote">表示された語句をヒントに英作文モードで発話してください。</p>
        <div id="composeTokens" class="compose-token-list" role="list"></div>
      </div>
      <div id="transcript" class="muted"></div>

      <div class="kpi">
        <div>一致率 <span class="val match-val" id="valMatch">—</span></div>
        <div>Lv <span class="val" id="valLevel">—</span></div>
        <div id="attemptInfo" class="attempt-info"></div>
      </div>

      <div class="audio-ctrls">
        <button id="btnPlay" class="btn" type="button" aria-label="音声を再生/一時停止"><span class="playIcon">▶️</span></button>
        <button id="btnMic" class="btn" type="button" aria-label="マイク開始/停止"><span class="micIcon">🎤</span></button>
        <div class="speed-ctrl" role="group" aria-labelledby="speedLabel">
          <span id="speedLabel" class="sr-only">再生速度</span>
          <button id="speedDown" class="speed-btn" type="button" aria-label="再生速度を下げる"><span aria-hidden="true">🐢</span></button>
          <input id="speedSlider" class="speed-slider" type="range" min="0.5" max="1.5" step="0.05" value="1" aria-labelledby="speedLabel">
          <button id="speedUp" class="speed-btn" type="button" aria-label="再生速度を上げる"><span aria-hidden="true">🐇</span></button>
          <span class="speed-bubble" id="speedValue" aria-live="polite">1.0×</span>
        </div>
      </div>
      <button id="btnNext" class="btn next-cta" type="button" hidden>次へ</button>
    </section>
  </main>

  <footer>
    <progress id="pbar" value="0" max="1"></progress>
    <div id="footerInfo" class="footer-info" data-dialog="footer-info">
      <span id="footerMessage" class="muted" aria-live="polite"></span>
      <button id="footerInfoBtn" type="button" aria-label="学習ルールの詳細" title="学習ルールの詳細">ℹ️</button>
    </div>
    <div class="grow"></div>
  </footer>
</div>

<audio id="player" preload="auto" crossorigin="anonymous"></audio>
<div id="milestoneEffects" aria-live="polite" aria-atomic="true"></div>
<div id="toast" role="status" aria-live="polite"></div>
<dialog id="footerInfoDialog" class="info-dialog" data-dialog="footer-info" aria-labelledby="footerInfoDialogTitle">
  <form method="dialog" class="info-dialog__form">
    <h3 id="footerInfoDialogTitle">学習ルール</h3>
    <div id="footerInfoDialogBody" class="info-dialog__body"></div>
    <div class="info-dialog__actions">
      <button value="close" class="btn">閉じる</button>
    </div>
  </form>
</dialog>

<!-- 設定モーダル -->
<div id="cfgModal">
  <div id="cfgBox">
    <h3>接続設定</h3>
    <label>GAS Web App URL（/exec）
      <input id="cfgUrl" type="url" placeholder="https://script.google.com/macros/s/.../exec">
    </label>
    <label>API Key（未設定でも可）
      <input id="cfgKey" type="text" placeholder="（空でも可）">
    </label>
    <label>音源ベースURL（例: https://example.com/audio または ./audio）
      <input id="cfgAudioBase" type="text" placeholder="./audio">
    </label>
    <fieldset class="cfg-fieldset">
      <legend>再生方法</legend>
      <label class="cfg-radio"><input type="radio" name="cfgPlaybackMode" value="audio"> 音源のみ</label>
      <label class="cfg-radio"><input type="radio" name="cfgPlaybackMode" value="speech"> 合成音声のみ</label>
    </fieldset>
    <fieldset class="cfg-fieldset">
      <legend>学習モード</legend>
      <label class="cfg-radio"><input type="radio" name="cfgStudyMode" value="read"> 通常モード（音読・リピーティング）</label>
      <label class="cfg-radio"><input type="radio" name="cfgStudyMode" value="compose"> 整序英作文ガイド（語順ヒントを表示）</label>
      <p class="cfg-note">整序英作文を有効化すると、英文ヒントの代わりにランダムな語句タグが表示されます。設定を保存すると次のカードから適用されます。</p>
    </fieldset>
    <label>音声合成の声
      <select id="cfgSpeechVoice"></select>
    </label>
    <div class="row" style="margin-top:8px">
      <button id="btnPickDir" class="btn">音源フォルダを指定（フォルダピッカー）</button>
      <button id="btnClearDir" class="btn">フォルダ解除</button>
      <span id="dirStatus" class="muted" style="font-size:12px"></span>
    </div>
    <div class="row" style="margin-top:8px">
      <input id="filePick" type="file" accept="audio/*" multiple style="display:none">
      <button id="btnImport" class="btn">音源ファイルをOPFSへ取り込み</button>
      <button id="btnTestAudio" class="btn">テスト再生</button>
      <div class="grow"></div>
      <button id="cfgClose" class="btn">閉じる</button>
      <button id="cfgSave" class="btn" style="background:#1a2134;border-color:#233252">保存</button>
    </div>
    <div class="row" style="margin-top:12px">
      <button id="btnNotifPerm" class="btn">学習リマインド通知を有効化</button>
      <span id="notifStatus" class="muted" style="font-size:12px"></span>
    </div>
  </div>
</div>

<script type="module" src="scripts/app/main.js"></script>
</body>
</html>
