<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>英語学習（範囲UI＋ASR・安定改良版）</title>
  <!-- ★ PWA 追加 -->
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192.png">
  <link rel="stylesheet" href="styles/app.css">
  <meta name="theme-color" content="#0b0e1a" />
</head>
<body>
<div id="loadingOverlay" role="presentation" aria-hidden="true">
  <div class="loaderAura">
    <div class="loaderRing"></div>
    <div class="loaderCore"></div>
    <div class="loaderDots" aria-hidden="true"><span></span><span></span><span></span></div>
  </div>
</div>
<div id="dirPermOverlay" hidden aria-hidden="true">
  <div id="dirPermBox" role="dialog" aria-modal="true" aria-labelledby="dirPermTitle">
    <h2 id="dirPermTitle">音声フォルダへのアクセス許可が必要です</h2>
    <p>保存済みの音声フォルダにアクセスするには、端末のダイアログで「許可する」を選んでください。アクセスを許可しない場合、音声が再生できないことがあります。</p>
    <div id="dirPermStatus" aria-live="polite"></div>
    <div class="actions">
      <button id="dirPermLater" class="btn" hidden>許可せず続行</button>
      <button id="dirPermAllow" class="btn ok">許可を開く</button>
    </div>
  </div>
</div>
<div id="app">
  <header>
    <div class="stat">
      <span class="stat-main" id="statSection">—</span>
    </div>
    <div class="stat">
      <span class="stat-sub">Lv</span>
      <span class="stat-main" id="statLevelAvg">—</span>
    </div>
    <div class="stat">
      <span class="stat-main" id="statProgressCurrent">0</span>
      <span class="stat-sub">/</span>
      <span class="stat-main" id="statProgressTotal">0</span>
    </div>
    <div class="grow"></div>
    <button id="btnCfg" class="icon-btn" type="button" aria-label="設定を開く" title="設定">⚙️</button>
  </header>

  <div class="goal-row goal-row--top">
    <div class="goal-card" id="dailyGoalCard">
      <div class="goal-card__header">
        <div class="goal-card__header-main">
          <span class="goal-card__title">今日の目標</span>
          <span class="goal-card__tag" id="dailyGoalTag">—</span>
        </div>
        <div class="goal-card__header-actions">
          <button id="dailyGoalToggle" class="goal-toggle" type="button" aria-expanded="true" aria-controls="dailyGoalBody" aria-label="今日の目標を折りたたむ">⌄</button>
        </div>
      </div>
      <div class="goal-card__body" id="dailyGoalBody">
        <div class="goal-ring" id="dailyGoalRing" aria-hidden="true">
          <div class="goal-ring__center" id="dailyGoalPercent">0%</div>
        </div>
        <div class="goal-card__meta">
          <div class="goal-card__value"><span id="dailyGoalDone">0</span>/<span id="dailyGoalTarget">10</span>件</div>
          <div class="goal-card__sub" id="dailyGoalHint">目標まであと10件</div>
        </div>
      </div>
    </div>
  </div>

  <!-- 出題範囲（ネイティブピッカー） -->
  <div id="rangeBar">
    <div class="range-item">
      <label class="sr-only" for="secSel">セクション</label>
      <select id="secSel" aria-label="セクション選択"></select>
    </div>
    <div class="range-item">
      <span class="sr-only" id="levelFilterLabel">レベル</span>
      <div id="levelFilter" class="level-filter" role="group" aria-labelledby="levelFilterLabel"></div>
    </div>
    <div class="range-item">
      <label class="sr-only" for="orderSel">並び</label>
      <select id="orderSel" aria-label="並び順">
        <option value="asc">昇順</option>
        <option value="srs">復習優先</option>
        <option value="rnd">ランダム</option>
      </select>
    </div>
    <div class="range-item">
      <label class="sr-only" for="rangeSearch">検索</label>
      <div class="search-input">
        <input id="rangeSearch" type="search" placeholder="単語検索" autocomplete="off" />
      </div>
    </div>
  </div>

  <main>
    <section class="overview-card" id="dailyOverviewCard">
      <div class="overview-card__header">
        <div class="overview-card__title-group">
          <p class="overview-card__title">今日の概要</p>
          <p class="overview-card__subtitle" id="dailyOverviewNote">学習の流れをさっと確認しましょう</p>
        </div>
        <div class="overview-card__header-actions">
          <span class="overview-chip" id="dailyOverviewDiff" aria-live="polite">—</span>
          <button id="dailyOverviewToggle" class="overview-toggle" type="button" aria-expanded="true" aria-controls="dailyOverviewBody" aria-label="今日の概要を折りたたむ">⌄</button>
        </div>
      </div>
      <div class="overview-card__body" id="dailyOverviewBody">
        <div class="overview-insights" id="dailyOverviewHighlights" aria-live="polite"></div>
        <div class="overview-grid">
          <div class="overview-section overview-section--trend">
            <div class="overview-section__title">昨日比</div>
            <div class="trend-bars">
              <div class="trend-bar">
                <span class="trend-bar__label">今日</span>
                <div class="trend-bar__track"><div class="trend-bar__fill" id="overviewTodayFill"></div></div>
                <span class="trend-bar__value" id="overviewTodayValue">0件</span>
              </div>
              <div class="trend-bar">
                <span class="trend-bar__label">昨日</span>
                <div class="trend-bar__track"><div class="trend-bar__fill trend-bar__fill--muted" id="overviewYesterdayFill"></div></div>
                <span class="trend-bar__value" id="overviewYesterdayValue">0件</span>
              </div>
            </div>
            <div class="trend-diff" id="dailyOverviewTrendStatus">—</div>
          </div>
          <div class="overview-section overview-section--promotion">
            <div class="overview-section__title">次の昇格条件</div>
            <div class="overview-status" id="overviewPromotionStatus">—</div>
          </div>
          <div class="overview-section overview-section--milestones">
            <div class="overview-section__title">最新のLv4/Lv5達成履歴</div>
            <div class="overview-list" id="overviewMilestones"></div>
          </div>
        </div>
        <div class="overview-actions">
          <button class="btn btn-primary" id="overviewQuickStart" type="button">すぐ始める</button>
        </div>
      </div>
    </section>

    <section class="card" id="card" aria-live="polite">
      <div class="chips" id="chips"></div>
      <div id="enText" class="en">出題を準備しています…（下スワイプで和訳）</div>
      <div id="jaText" class="ja">—</div>
      <div id="composeGuide" class="compose-guide" aria-hidden="true">
        <h4>並び替えガイド</h4>
        <p id="composeNote">表示された語句をヒントに英作文モードで発話してください。</p>
        <div id="composeTokens" class="compose-token-list" role="list"></div>
      </div>
      <div id="transcript" class="muted"></div>

      <div class="kpi">
        <div>一致率 <span class="val match-val" id="valMatch">—</span></div>
        <div>Lv <span class="val" id="valLevel">—</span></div>
        <div id="attemptInfo" class="attempt-info"></div>
      </div>

      <div class="audio-ctrls">
        <button id="btnPlay" class="btn" type="button" aria-label="音声を再生/一時停止"><span class="playIcon">▶️</span></button>
        <button id="btnMic" class="btn" type="button" aria-label="マイク開始/停止"><span class="micIcon">🎤</span></button>
        <div class="speed-ctrl" role="group" aria-labelledby="speedLabel">
          <span id="speedLabel" class="sr-only">再生速度</span>
          <button id="speedDown" class="speed-btn" type="button" aria-label="再生速度を下げる"><span aria-hidden="true">🐢</span></button>
          <input id="speedSlider" class="speed-slider" type="range" min="0.5" max="1.5" step="0.05" value="1" aria-labelledby="speedLabel">
          <button id="speedUp" class="speed-btn" type="button" aria-label="再生速度を上げる"><span aria-hidden="true">🐇</span></button>
          <span class="speed-bubble" id="speedValue" aria-live="polite">1.0×</span>
        </div>
      </div>
    </section>
  </main>

  <div class="goal-row goal-row--footer">
    <div class="goal-card goal-card--session" id="sessionGoalCard">
      <div class="goal-card__header">
        <div class="goal-card__header-main">
          <span class="goal-card__title">セッション目標</span>
          <span class="goal-card__tag" id="sessionGoalTag">—</span>
        </div>
        <div class="goal-card__header-actions">
          <button id="sessionGoalToggle" class="goal-toggle" type="button" aria-expanded="true" aria-controls="sessionGoalBody" aria-label="セッション目標を折りたたむ">⌄</button>
        </div>
      </div>
      <div class="goal-card__body goal-card__body--session" id="sessionGoalBody">
        <div class="goal-ring goal-ring--sm" id="sessionGoalRing" aria-hidden="true">
          <div class="goal-ring__center" id="sessionGoalPercent">0%</div>
        </div>
        <div class="goal-card__meta goal-card__meta--session">
          <div class="goal-card__value"><span id="sessionGoalDone">0</span>/<span id="sessionGoalTarget">5</span>件</div>
          <div class="session-goal__controls">
            <label class="sr-only" for="sessionGoalSlider">セッション目標の件数</label>
            <input id="sessionGoalSlider" type="range" min="1" max="30" step="1" value="5">
            <div class="session-goal__bar">
              <div class="session-goal__bar-fill" id="sessionGoalBarFill"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <progress id="pbar" value="0" max="1"></progress>
    <div id="footerInfo" class="footer-info" data-dialog="footer-info">
      <span id="footerMessage" class="muted" aria-live="polite"></span>
      <span id="nextActionMessage" class="muted" aria-live="polite"></span>
      <button id="footerInfoBtn" type="button" aria-label="学習ルールの詳細" title="学習ルールの詳細">ℹ️</button>
    </div>
    <div class="grow"></div>
    <span class="version-tag" data-app-version aria-label="アプリのバージョン" aria-live="polite"></span>
  </footer>
</div>

<audio id="player" preload="auto" crossorigin="anonymous"></audio>
<div id="milestoneEffects" aria-live="polite" aria-atomic="true"></div>
<div id="toast" role="status" aria-live="polite"></div>
<dialog id="footerInfoDialog" class="info-dialog" data-dialog="footer-info" aria-labelledby="footerInfoDialogTitle">
  <form method="dialog" class="info-dialog__form">
    <h3 id="footerInfoDialogTitle">学習ルール</h3>
    <div id="footerInfoDialogBody" class="info-dialog__body"></div>
    <div class="info-dialog__actions">
      <button value="close" class="btn">閉じる</button>
    </div>
  </form>
</dialog>

<!-- 設定モーダル -->
<div id="cfgModal">
  <div id="cfgBox">
    <div class="cfg-header">
      <h3>接続設定</h3>
      <p class="muted version-tag" data-app-version aria-live="polite"></p>
    </div>
    <div class="cfg-scroll">
      <label>GAS Web App URL（/exec）
        <input id="cfgUrl" type="url" placeholder="https://script.google.com/macros/s/.../exec">
      </label>
      <label>API Key（未設定でも可）
        <input id="cfgKey" type="text" placeholder="（空でも可）">
      </label>
      <label>音源ベースURL（例: https://example.com/audio または ./audio）
        <input id="cfgAudioBase" type="text" placeholder="./audio">
      </label>
      <fieldset class="cfg-fieldset">
        <legend>再生方法</legend>
        <label class="cfg-radio"><input type="radio" name="cfgPlaybackMode" value="audio"> 音源のみ</label>
        <label class="cfg-radio"><input type="radio" name="cfgPlaybackMode" value="speech"> 合成音声のみ</label>
      </fieldset>
      <fieldset class="cfg-fieldset">
        <legend>学習モード</legend>
        <label class="cfg-radio"><input type="radio" name="cfgStudyMode" value="read"> 通常モード（音読・リピーティング）</label>
        <label class="cfg-radio"><input type="radio" name="cfgStudyMode" value="compose"> 整序英作文ガイド（語順ヒントを表示）</label>
        <p class="cfg-note">整序英作文を有効化すると、英文ヒントの代わりにランダムな語句タグが表示されます。設定を保存すると次のカードから適用されます。</p>
      </fieldset>
      <label>音声合成の声
        <select id="cfgSpeechVoice"></select>
      </label>
      <div class="cfg-section">
        <p class="cfg-section-title">通知・接続</p>
        <div class="row cfg-row">
          <button id="btnNotifPerm" class="btn">学習リマインド通知を有効化</button>
          <span id="notifStatus" class="muted cfg-status"></span>
        </div>
        <p id="notifHelp" class="cfg-note"></p>
        <div class="cfg-subsection">
          <p class="cfg-subtitle">リマインダー時間</p>
          <div id="notifTimeList" class="notif-time-list"></div>
          <button id="notifTimeAdd" type="button" class="btn btn-ghost">時刻を追加</button>
        </div>
        <fieldset class="cfg-fieldset cfg-fieldset-inline">
          <legend>通知トリガー</legend>
          <label class="cfg-check"><input type="checkbox" id="notifTriggerDailyZero"> 未学習リマインド（合格0件をお知らせ）</label>
          <label class="cfg-check"><input type="checkbox" id="notifTriggerDailyCompare"> 昨日との進捗比較</label>
          <label class="cfg-check"><input type="checkbox" id="notifTriggerWeekly"> 週次振り返り</label>
        </fieldset>
      </div>
      <div class="cfg-divider" role="presentation"></div>
      <div class="cfg-section">
        <p class="cfg-section-title">ファイル</p>
        <div class="row cfg-row">
          <button id="btnPickDir" class="btn">音源フォルダを指定（フォルダピッカー）</button>
          <button id="btnClearDir" class="btn">フォルダ解除</button>
        </div>
        <div class="row cfg-row">
          <span id="dirStatus" class="muted cfg-status"></span>
        </div>
      </div>
    </div>
    <div class="cfg-actions-bar row cfg-actions">
      <div class="grow"></div>
      <button id="cfgClose" class="btn">閉じる</button>
      <button id="cfgSave" class="btn" style="background:#1a2134;border-color:#233252">保存</button>
    </div>
  </div>
</div>

<script type="module" src="scripts/app/main.js"></script>
</body>
</html>
