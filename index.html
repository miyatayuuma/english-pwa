<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>è‹±èªå­¦ç¿’ï¼ˆç¯„å›²UIï¼‹ASRãƒ»å®‰å®šæ”¹è‰¯ç‰ˆï¼‰</title>
  <style>
    :root{ --bg:#0b0e1a; --panel:rgba(20,24,36,.65); --bd:rgba(255,255,255,.12); --txt:#e6e8ef; --muted:#aeb5c6; --accent:#62d5ff; --good:#46d37f; --bad:#ff6b6b; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,"Segoe UI","Noto Sans JP",sans-serif}
    #app{position:fixed;inset:0;display:grid;grid-template-rows:auto auto 1fr auto}

    header{padding:10px 12px;display:flex;gap:12px;align-items:center;background:var(--panel);border-bottom:1px solid var(--bd)}
    .stat{display:flex;gap:6px;align-items:baseline;font-size:14px;color:var(--muted)} .stat b{font-size:18px;color:var(--txt)} .grow{flex:1}
    .icon{width:38px;height:38px;border-radius:999px;border:1px solid var(--bd);display:grid;place-items:center;cursor:pointer;background:#111726}

    /* ç¯„å›²UIï¼ˆãƒã‚¤ãƒ†ã‚£ãƒ–ã‚»ãƒ¬ã‚¯ãƒˆä¸­å¿ƒï¼ãƒ¢ãƒã‚¤ãƒ«æœ€é©ï¼‰ */
    #rangeBar{display:flex;gap:8px;align-items:center;padding:8px 12px;background:rgba(20,24,36,.5);border-bottom:1px solid rgba(255,255,255,.12);overflow:auto}
    select, .switch{background:#111726;border:1px solid var(--bd);color:var(--txt);border-radius:12px;padding:8px}
    .switch{display:flex;gap:8px;align-items:center}

    main{padding:12px;overflow:auto}
    .card{max-width:840px;margin:0 auto;background:var(--panel);border:1px solid var(--bd);border-radius:18px;padding:16px;min-height:50vh;display:flex;flex-direction:column;gap:12px;touch-action:manipulation}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .en{font-size:22px;line-height:1.6;word-break:normal;overflow-wrap:break-word;white-space:normal}
    .en .tok{padding:0 2px;border-radius:4px}
    .en .hit{background:rgba(70,211,127,.18);border-bottom:1px solid rgba(70,211,127,.6)}
    .en .miss{background:rgba(255,107,107,.15);border-bottom:1px dashed rgba(255,107,107,.7)}
    .ja{font-size:16px;color:var(--muted);display:none}
    #transcript{min-height:1.6em}
    #transcript .interim{opacity:.6}

    .scorebox{display:flex;flex-direction:column;gap:6px;background:rgba(10,14,24,.6);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:10px 12px}
    .scoreline{display:flex;align-items:baseline;justify-content:space-between;font-size:14px;color:var(--muted)}
    .score-val{font-size:26px;font-weight:700;color:var(--muted);transition:color .3s ease, transform .3s ease}
    .score-val.good{color:var(--good);transform:translateY(-1px)}
    .score-val.warn{color:#f5a524}
    .score-val.bad{color:var(--bad)}
    .score-note{font-size:12px;color:var(--muted);min-height:1.2em}

    footer{border-top:1px solid var(--bd);padding:8px 12px;display:flex;gap:10px;align-items:center;background:var(--panel)}
    progress{width:160px;height:10px}
    .btn{border:1px solid var(--bd);border-radius:12px;background:#111726;color:var(--txt);padding:10px 14px;cursor:pointer}
    .btn.ok{background:#10331f;border-color:#1f5c38}
    .btn.ng{background:#331717;border-color:#5c2929}
    #btnMic{width:100%;height:64px;font-size:30px;padding:0;border-radius:18px;background:linear-gradient(135deg,#1a2134,#12192a);border:1px solid #2a3753;display:grid;place-items:center;position:relative;transition:transform .25s ease, box-shadow .25s ease, background .35s ease}
    #btnMic span{font-size:32px;transform:translateY(1px)}
    #btnMic.listening{background:radial-gradient(circle at 50% 45%,rgba(98,213,255,.25),rgba(18,25,42,1));box-shadow:0 0 0 0 rgba(98,213,255,.45);animation:micPulse 1.5s ease-in-out infinite}
    #btnMic.listening span{filter:drop-shadow(0 0 6px rgba(98,213,255,.7))}
    #btnMic:disabled{opacity:.4;cursor:not-allowed;animation:none;box-shadow:none}
    #btnMic::after{content:"";position:absolute;inset:-4px;border-radius:20px;border:1px solid rgba(98,213,255,.25);opacity:0;transition:opacity .3s ease}
    #btnMic.listening::after{opacity:1}
    @keyframes micPulse{0%{box-shadow:0 0 0 0 rgba(98,213,255,.45);}70%{box-shadow:0 0 0 10px rgba(98,213,255,0);}100%{box-shadow:0 0 0 0 rgba(98,213,255,0);}}
    #btnAutoNext{display:none;margin-top:6px;width:100%;padding:12px;font-size:16px;border-radius:14px;background:#215439;border:1px solid #2f7a52;color:#e6ffef;font-weight:600;box-shadow:0 6px 14px -10px rgba(70,211,127,.8);transition:transform .2s ease, box-shadow .2s ease}
    #btnAutoNext:focus-visible{outline:2px solid rgba(98,213,255,.6)}
    #btnAutoNext:hover{transform:translateY(-1px);box-shadow:0 10px 18px -12px rgba(70,211,127,1)}

    /* è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */
    #cfgModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:9999}
    #cfgBox{width:min(560px,92%);background:#111726;border:1px solid var(--bd);border-radius:14px;padding:16px}
    #cfgBox h3{margin:0 0 8px 0}
    #cfgBox label{display:block;margin:10px 0}
    #cfgBox input[type="text"], #cfgBox input[type="url"]{width:100%;padding:8px;border-radius:10px;border:1px solid var(--bd);background:#0c1221;color:var(--txt)}
    #cfgBox .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    #toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#0f1422;border:1px solid #24304a;color:#b7c0d6;border-radius:10px;padding:8px 12px;z-index:99999;display:none}
  </style>
</head>
<body>
<div id="app">
  <header>
    <div class="stat">æ®‹ <b id="statLeft">0</b></div>
    <div class="stat">åˆ† <b id="statMin">0</b></div>
    <div class="stat">streak <b id="statStreak">0</b></div>
    <div class="grow"></div>
    <div id="btnCfg" class="icon" title="è¨­å®š">âš™ï¸</div>
  </header>

  <!-- å‡ºé¡Œç¯„å›²ï¼ˆãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ”ãƒƒã‚«ãƒ¼ï¼‰ -->
  <div id="rangeBar">
    <label>ã‚»ã‚¯ã‚·ãƒ§ãƒ³
      <select id="secSel"></select>
    </label>
    <label>ä¸¦ã³
      <select id="orderSel">
        <option value="asc">æ˜‡é †</option>
        <option value="rnd">ãƒ©ãƒ³ãƒ€ãƒ </option>
      </select>
    </label>
    <label class="switch"><input id="chkOnlyWeak" type="checkbox"> æœªç¿’å¾—ã®ã¿</label>
  </div>

  <main>
    <section class="card" id="card" aria-live="polite">
      <div class="chips" id="chips"></div>
      <div id="enText" class="en">ã‚¿ãƒƒãƒ—ã§å†ç”Ÿ / ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã§å’Œè¨³</div>
      <div id="jaText" class="ja">â€”</div>
      <div id="transcript" class="muted"></div>

      <div class="scorebox" role="status" aria-live="polite">
        <div class="scoreline"><span>ä¸€è‡´ç‡</span><span class="score-val" id="valScore">â€”</span></div>
        <div class="score-note" id="asrState">ãƒã‚¤ã‚¯ã‚’æŠ¼ã—ã¦ç™ºå£°ã—ã¦ãã ã•ã„</div>
      </div>

      <div style="display:flex;gap:8px">
        <button class="btn ok" data-eval="ok">â—¯ å¾—æ„</button>
        <button class="btn ng" data-eval="ng">Ã— è‹¦æ‰‹</button>
      </div>
      <button id="btnMic" class="btn" type="button" aria-label="ãƒã‚¤ã‚¯é–‹å§‹"><span>ğŸ™ï¸</span></button>
      <button id="btnAutoNext" type="button">æ¬¡ã¸</button>
    </section>
  </main>

  <footer>
    <progress id="pbar" value="0" max="1"></progress>
    <span id="footerInfo" class="muted">å·¦å³ã‚¹ãƒ¯ã‚¤ãƒ—ï¼šæˆ»ã‚‹/é€²ã‚€ã€€ä¸Šï¼šå’Œè¨³</span>
    <div class="grow"></div>
    <button id="btnNext" class="btn" disabled style="display:none">æ¬¡ã¸</button>
  </footer>
</div>

<audio id="player" preload="auto" crossorigin="anonymous"></audio>
<div id="toast"></div>

<!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="cfgModal">
  <div id="cfgBox">
    <h3>æ¥ç¶šè¨­å®š</h3>
    <label>GAS Web App URLï¼ˆ/execï¼‰
      <input id="cfgUrl" type="url" placeholder="https://script.google.com/macros/s/.../exec">
    </label>
    <label>API Keyï¼ˆæœªè¨­å®šã§ã‚‚å¯ï¼‰
      <input id="cfgKey" type="text" placeholder="ï¼ˆç©ºã§ã‚‚å¯ï¼‰">
    </label>
    <label>éŸ³æºãƒ™ãƒ¼ã‚¹URLï¼ˆä¾‹: https://example.com/audio ã¾ãŸã¯ ./audioï¼‰
      <input id="cfgAudioBase" type="text" placeholder="./audio">
    </label>
    <div class="row" style="margin-top:8px">
      <button id="btnPickDir" class="btn">éŸ³æºãƒ•ã‚©ãƒ«ãƒ€ã‚’æŒ‡å®šï¼ˆãƒ•ã‚©ãƒ«ãƒ€ãƒ”ãƒƒã‚«ãƒ¼ï¼‰</button>
      <button id="btnClearDir" class="btn">ãƒ•ã‚©ãƒ«ãƒ€è§£é™¤</button>
      <span id="dirStatus" class="muted" style="font-size:12px"></span>
    </div>
    <div class="row" style="margin-top:8px">
      <input id="filePick" type="file" accept="audio/*" multiple style="display:none">
      <button id="btnImport" class="btn">éŸ³æºãƒ•ã‚¡ã‚¤ãƒ«ã‚’OPFSã¸å–ã‚Šè¾¼ã¿</button>
      <button id="btnTestAudio" class="btn">ãƒ†ã‚¹ãƒˆå†ç”Ÿ</button>
      <div class="grow"></div>
      <button id="cfgClose" class="btn">é–‰ã˜ã‚‹</button>
      <button id="cfgSave" class="btn" style="background:#1a2134;border-color:#233252">ä¿å­˜</button>
    </div>
  </div>
</div>

<script>
(function(){
  // ===== Utilities =====
  const qs=(s,el=document)=>el.querySelector(s);
  const qsa=(s,el=document)=>[...el.querySelectorAll(s)];
  const now=()=>Date.now(); const UA=(()=>navigator.userAgent||'')();
  const norm=s=>(s||'').toLowerCase().normalize('NFKC').replace(/[\p{P}\p{S}]/gu,' ').replace(/\s+/g,' ').trim();
  const toks=s=>norm(s).split(' ').filter(Boolean);
  // é€£ç¶šé‡è¤‡ã‚’åœ§ç¸®ï¼ˆa a a â†’ aï¼‰
  function dedupeRuns(arr){
    const out=[]; for(const w of arr){ if(out.length && out[out.length-1]===w) continue; out.push(w); }
    return out;
  }
  // final æ–‡ã®â€œå¢—åˆ†â€ã ã‘ã‚’å®‰å®šãƒ†ã‚­ã‚¹ãƒˆã«è¿½åŠ 
  function appendStableFinal(stable, fragment){
    const A = toks(stable);
    const B = toks(fragment);
    // èªå˜ä½LCP
    let k = 0;
    while (k < A.length && k < B.length && A[k] === B[k]) k++;
    // B ãŒ A ã®æ‹¡å¼µãªã‚‰å°¾éƒ¨ã ã‘è¿½åŠ ã€‚æ‹¡å¼µã§ãªã‘ã‚Œã°æ–°è¦æ–‡ã¨ã—ã¦çµåˆã€‚
    const merged = (k > 0 || !A.length) ? A.concat(B.slice(k)) : A.concat(B);
    return dedupeRuns(merged).join(' ');
  }
  function spanify(text){
    const parts=(text||'').match(/\S+|\s+/g)||[];
    return parts.map(part=>{
      if(/\s+/.test(part)){
        const converted=part
          .replace(/\r?\n/g,'<br>')
          .replace(/[^\S\r\n]+/g,' ');
        return converted || ' ';
      }
      const clean=part.replace(/[^\p{L}\p{N}'-]/gu,'');
      return `<span class="tok" data-w="${clean}">${part}</span>`;
    }).join('');
  }
  function toast(msg, ms=1500){ const t=qs('#toast'); t.textContent=msg; t.style.display='block'; clearTimeout(toast._t); toast._t=setTimeout(()=>t.style.display='none', ms); }
  let AUDIO_CTX=null;
  function ensureAudioCtx(){
    if(AUDIO_CTX) return AUDIO_CTX;
    try{ AUDIO_CTX=new (window.AudioContext||window.webkitAudioContext)(); }
    catch(_){ AUDIO_CTX=null; }
    return AUDIO_CTX;
  }
  function playTone(freq=880,duration=0.12,type='sine',gain=0.2){
    const ctx=ensureAudioCtx();
    if(!ctx) return;
    if(ctx.state==='suspended'){ try{ ctx.resume(); }catch(_){}}
    const osc=ctx.createOscillator();
    const amp=ctx.createGain();
    osc.type=type;
    osc.frequency.value=freq;
    amp.gain.value=gain;
    osc.connect(amp).connect(ctx.destination);
    const t=ctx.currentTime;
    amp.gain.setValueAtTime(gain,t);
    amp.gain.exponentialRampToValueAtTime(0.001,t+Math.max(0.05,duration));
    osc.start(t);
    osc.stop(t+Math.max(0.08,duration));
  }

  // ===== Elements =====
  const el={ left:qs('#statLeft'), min:qs('#statMin'), streak:qs('#statStreak'), pbar:qs('#pbar'), footer:qs('#footerInfo'), en:qs('#enText'), ja:qs('#jaText'), chips:qs('#chips'), asr:qs('#asrState'), score:qs('#valScore'), next:qs('#btnNext'), autoNext:qs('#btnAutoNext'), mic:qs('#btnMic'), card:qs('#card'), secSel:qs('#secSel'), orderSel:qs('#orderSel'), chkWeak:qs('#chkOnlyWeak'), cfgBtn:qs('#btnCfg'), cfgModal:qs('#cfgModal'), cfgUrl:qs('#cfgUrl'), cfgKey:qs('#cfgKey'), cfgAudioBase:qs('#cfgAudioBase'), cfgSave:qs('#cfgSave'), cfgClose:qs('#cfgClose'), btnImport:qs('#btnImport'), filePick:qs('#filePick'), btnTestAudio:qs('#btnTestAudio'), btnPickDir:qs('#btnPickDir'), btnClearDir:qs('#btnClearDir'), dirStatus:qs('#dirStatus') };
  const audio=qs('#player');
  const PREFETCH_POOL=new Map();
  const PREFETCH_LIMIT=6;
  hideAutoNext();

  function waitForAudioReady(el, timeout=2000){
    if(!el) return Promise.resolve();
    if(el.readyState>=2) return Promise.resolve();
    return new Promise(resolve=>{
      let settled=false;
      const finalize=()=>{
        if(settled) return;
        settled=true;
        el.removeEventListener('canplay', onReady);
        el.removeEventListener('canplaythrough', onReady);
        el.removeEventListener('loadeddata', onReady);
        el.removeEventListener('error', onReady);
        clearTimeout(timer);
        resolve();
      };
      const onReady=()=>finalize();
      const timer=setTimeout(()=>finalize(), timeout);
      el.addEventListener('canplay', onReady, {once:true});
      el.addEventListener('canplaythrough', onReady, {once:true});
      el.addEventListener('loadeddata', onReady, {once:true});
      el.addEventListener('error', onReady, {once:true});
    });
  }

  async function setAudioSource(url){
    if(!url){
      clearAudioSource();
      return;
    }
    if(audio.dataset.srcKey !== url){
      audio.dataset.srcKey = url;
      audio.src = url;
    }
    try{ audio.load?.(); }catch(_){ }
    await waitForAudioReady(audio, 2000);
  }

  function clearAudioSource(){
    delete audio.dataset.srcKey;
    audio.removeAttribute('src');
    try{ audio.load?.(); }catch(_){ }
  }

  function rememberPrefetch(url, entry){
    PREFETCH_POOL.set(url, entry);
    if(PREFETCH_POOL.size>PREFETCH_LIMIT){
      const firstKey=PREFETCH_POOL.keys().next().value;
      const old=PREFETCH_POOL.get(firstKey);
      if(old && old.audio){
        try{ old.audio.pause?.(); }catch(_){ }
        old.audio.removeAttribute?.('src');
      }
      PREFETCH_POOL.delete(firstKey);
    }
  }

  // ===== Config =====
  const CFG_KEY='appConfigV3';
  function loadCfg(){ try{return JSON.parse(localStorage.getItem(CFG_KEY)||'{}')}catch(_){return{}} }
  function saveCfg(o){ localStorage.setItem(CFG_KEY, JSON.stringify(o)); }
  let CFG=Object.assign({ apiUrl:'', apiKey:'', audioBase:'./audio' }, loadCfg());

  // ===== IndexedDB for DirectoryHandle =====
  const DB='fs-handles', STORE='dir';
  function idb(){ return new Promise((res,rej)=>{ const r=indexedDB.open(DB,1); r.onupgradeneeded=()=>{ r.result.createObjectStore(STORE); }; r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); }); }
  async function saveDirHandle(h){ const db=await idb(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readwrite'); tx.objectStore(STORE).put(h,'audio'); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); }); }
  async function loadDirHandle(){ const db=await idb(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readonly'); const rq=tx.objectStore(STORE).get('audio'); rq.onsuccess=()=>res(rq.result||null); rq.onerror=()=>rej(rq.error); }); }
  async function clearDirHandle(){ const db=await idb(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readwrite'); tx.objectStore(STORE).delete('audio'); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); }); }

  let DIR=null; // FileSystemDirectoryHandle
  async function ensureDir(){ if(DIR) return DIR; try{ DIR = await loadDirHandle(); if(!DIR) return null; const q = await DIR.queryPermission?.({mode:'read'}) || 'granted'; if(q!=='granted'){ const r = await DIR.requestPermission?.({mode:'read'}); if(r!=='granted'){ DIR=null; return null; } } return DIR; }catch(_){ DIR=null; return null; } }

  // Settings modal
  el.cfgBtn.onclick=()=>{ el.cfgUrl.value=CFG.apiUrl||''; el.cfgKey.value=CFG.apiKey||''; el.cfgAudioBase.value=CFG.audioBase||'./audio'; refreshDirStatus(); el.cfgModal.style.display='flex'; };
  el.cfgClose.onclick=()=>{ el.cfgModal.style.display='none'; };
  el.cfgSave.onclick=()=>{ CFG.apiUrl=(el.cfgUrl.value||'').trim(); CFG.apiKey=(el.cfgKey.value||'').trim(); CFG.audioBase=(el.cfgAudioBase.value||'').trim()||'./audio'; saveCfg(CFG); el.cfgModal.style.display='none'; toast('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ'); };
  el.btnPickDir.onclick=async()=>{ if(!window.showDirectoryPicker){ toast('ã“ã®ç«¯æœ«ã¯ãƒ•ã‚©ãƒ«ãƒ€ãƒ”ãƒƒã‚«ãƒ¼éå¯¾å¿œ'); return; } try{ const h=await showDirectoryPicker({mode:'read'}); await saveDirHandle(h); DIR=h; refreshDirStatus(); toast('ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä¿å­˜ã—ã¾ã—ãŸ'); }catch(e){ if(e&&e.name!=='AbortError') toast('ãƒ•ã‚©ãƒ«ãƒ€é¸æŠã«å¤±æ•—'); }};
  el.btnClearDir.onclick=async()=>{ await clearDirHandle(); DIR=null; refreshDirStatus(); toast('ãƒ•ã‚©ãƒ«ãƒ€è¨­å®šã‚’è§£é™¤'); };
  function refreshDirStatus(){ el.dirStatus.textContent = DIR? 'ä¿å­˜æ¸ˆã¿':'æœªè¨­å®š'; }

  // Import audio (OPFS)
  el.btnImport.onclick=()=>{ el.filePick.click(); };
  el.filePick.onchange=async (ev)=>{ const files=[...ev.target.files||[]]; if(!files.length){ toast('ãƒ•ã‚¡ã‚¤ãƒ«æœªé¸æŠ'); return; } try{ if(!(navigator.storage&&navigator.storage.getDirectory)) throw new Error('OPFSæœªå¯¾å¿œ'); const root=await navigator.storage.getDirectory(); let ok=0; for(const f of files){ const fh=await root.getFileHandle(f.name,{create:true}); const w=await fh.createWritable(); await w.write(f); await w.close(); ok++; } toast(`${ok} ä»¶ã‚’OPFSã¸ä¿å­˜`); }catch(e){ console.error(e); toast('OPFSå–ã‚Šè¾¼ã¿å¤±æ•—'); } };

  // GAS Bridge
  async function sendLog(type,data){ const url=(CFG.apiUrl||'').trim(); if(!url) return; const payload={apiKey:CFG.apiKey||undefined,type,data}; const blob=new Blob([JSON.stringify(payload)],{type:'text/plain;charset=UTF-8'}); if('sendBeacon' in navigator){ navigator.sendBeacon(url, blob); return; } try{ await fetch(url,{method:'POST',mode:'no-cors',body:blob}); }catch(_){} }

  // Data
  const DATA_URL='./data/items.json';
  async function fetchJson(url){ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error(url+': '+r.status); return r.json(); }
  window.ALL_ITEMS=[]; let SRS_MAP=new Map();
  async function ensureDataLoaded(){ if(!window.ALL_ITEMS.length){ window.ALL_ITEMS=await fetchJson(DATA_URL); } if(!SRS_MAP.size){ try{ const arr=await fetchJson('./data/srs.json'); const m=new Map(); for(const x of arr) m.set(x.id,x); SRS_MAP=m; }catch(_){ SRS_MAP=new Map(); } } }

  // Build section options (All/å˜ä¸€)
  function initSectionPicker(){ const sel=el.secSel; sel.innerHTML=''; sel.appendChild(new Option('å…¨ä½“','')); const units=[...new Set(window.ALL_ITEMS.map(x=>x.unit).filter(Boolean))].sort((a,b)=>{const na=+String(a).replace(/\D+/g,'')||0, nb=+String(b).replace(/\D+/g,'')||0; return na-nb||String(a).localeCompare(String(b));}); for(const u of units){ sel.appendChild(new Option(u,u)); } const saved=localStorage.getItem('secSel')||''; sel.value=saved; sel.onchange=()=>{ localStorage.setItem('secSel', sel.value); rebuildAndRender(true); };
    const ordSaved=localStorage.getItem('orderSel')||'asc'; el.orderSel.value=ordSaved; el.orderSel.onchange=()=>{ localStorage.setItem('orderSel', el.orderSel.value); rebuildAndRender(true); };
    el.chkWeak.checked = localStorage.getItem('onlyWeak')==='1'; el.chkWeak.onchange=()=>{ localStorage.setItem('onlyWeak', el.chkWeak.checked?'1':'0'); rebuildAndRender(true); };
  }

  function isUnlearned(id){ const s=SRS_MAP.get(id); if(!s) return true; if(s.last_result===0) return true; if((s.ease||0)<2.0 && (s.interval_d||0)<3) return true; return false; }
  function buildQueue(){ const sec=el.secSel.value; const order=el.orderSel.value; const onlyWeak=el.chkWeak.checked; let items=(sec?'filter':'all')==='all' ? window.ALL_ITEMS : window.ALL_ITEMS.filter(x=>String(x.unit)===sec); if(onlyWeak) items=items.filter(x=>isUnlearned(x.id)); if(order==='rnd'){ const seed=Math.floor(Date.now()/86400000); let t=seed>>>0; const rnd=()=>{t^=t<<13; t^=t>>>17; t^=t<<5; return (t>>>0)/4294967296}; items=items.slice(); for(let i=items.length-1;i>0;i--){ const j=Math.floor(rnd()*(i+1)); [items[i],items[j]]=[items[j]],items[i]; } } else { items=items.slice().sort((a,b)=>{ const na=+String(a.unit||'').replace(/\D+/g,'')||0, nb=+String(b.unit||'').replace(/\D+/g,'')||0; if(na!==nb) return na-nb; return String(a.id).localeCompare(String(b.id)); }); } return items.map(it=>({ id:it.id,en:it.en,ja:it.ja,tags:it.tags||'',chunks_json:it.chunks||'[]',audio_fn:it.audio_fn||'' })); }

  // Audio resolve: DIR (folder) -> OPFS -> base URL
  const audioUrlCache=new Map();
  async function resolveFromDir(name){ try{ const d=await ensureDir(); if(!d||!name) return ''; const fh=await d.getFileHandle(name).catch(()=>null); if(!fh) return ''; const f=await fh.getFile(); return URL.createObjectURL(f); }catch(_){ return ''; } }
  async function resolveFromOPFS(name){ if(!name) return ''; try{ if(!(navigator.storage&&navigator.storage.getDirectory)) return ''; const root=await navigator.storage.getDirectory(); const fh=await root.getFileHandle(name).catch(()=>null); if(!fh) return ''; const file=await fh.getFile(); return URL.createObjectURL(file); }catch(_){ return ''; } }
  async function resolveAudioUrl(name){ if(!name) return ''; if(audioUrlCache.has(name)) return audioUrlCache.get(name); let url=await resolveFromDir(name); if(!url) url=await resolveFromOPFS(name); if(!url){ const base=(CFG.audioBase||'./audio').replace(/\/$/,''); url= base + '/' + encodeURI(name); } audioUrlCache.set(name,url); return url; }

  async function primeAudio(item){
    if(!item||!item.audio_fn) return;
    const url=await resolveAudioUrl(item.audio_fn);
    if(!url) return;
    if(PREFETCH_POOL.has(url)) return PREFETCH_POOL.get(url).promise;
    const prefetch=new Audio();
    prefetch.preload='auto';
    prefetch.crossOrigin='anonymous';
    prefetch.src=url;
    const promise=waitForAudioReady(prefetch, 4000).finally(()=>{
      try{ prefetch.pause?.(); }catch(_){ }
    });
    try{ prefetch.load?.(); }catch(_){ }
    rememberPrefetch(url,{audio:prefetch,promise});
    return promise;
  }

  // Render & navigation
  let QUEUE=[], idx=-1, sessionStart=0, cardStart=0;
  let failCount=0, attemptCount=0;
  function stopAudio(){ try{audio.pause();}catch(_){ } audio.currentTime=0; }
  function resetResult(){
    el.score.textContent='â€”';
    el.score.classList.remove('good','warn','bad');
    el.asr.textContent='ãƒã‚¤ã‚¯ã‚’æŠ¼ã—ã¦ç™ºå£°ã—ã¦ãã ã•ã„';
  }
  function hideAutoNext(){
    el.autoNext.style.display='none';
    el.autoNext.disabled=false;
  }
  function showAutoNext(){
    el.autoNext.style.display='block';
    el.autoNext.disabled=false;
    if(typeof el.autoNext.focus==='function'){
      try{ el.autoNext.focus({preventScroll:true}); }
      catch(_){ try{ el.autoNext.focus(); }catch(_){}}
    }
  }
  function updateScore(rate){
    el.score.classList.remove('good','warn','bad');
    if(!isFinite(rate)){
      el.score.textContent='â€”';
      return;
    }
    const pct=Math.max(0,Math.min(100,Math.round(rate*100)));
    el.score.textContent=`${pct}%`;
    if(pct>=70){
      el.score.classList.add('good');
    }else if(pct>=40){
      el.score.classList.add('warn');
    }else{
      el.score.classList.add('bad');
    }
  }
  function toggleJA(){ el.ja.style.display=(el.ja.style.display==='none')?'block':'none'; }

  async function render(i, autoPlay=false){
    stopAudio();
    const it=QUEUE[i];
    if(!it){
      el.footer.textContent='ã‚­ãƒ¥ãƒ¼ãŒç©ºã§ã™';
      clearAudioSource();
      return;
    }
    el.en.innerHTML=spanify(it.en);
    el.ja.textContent=it.ja;
    el.ja.style.display='none';
    el.chips.innerHTML='';
    (it.tags||'').split(',').filter(Boolean).forEach(t=>{ const s=document.createElement('span'); s.className='chip'; s.textContent=t.trim(); el.chips.appendChild(s); });
    const url=await resolveAudioUrl(it.audio_fn);
    if(url){
      await setAudioSource(url);
    }else{
      clearAudioSource();
    }
    cardStart=now();
    failCount=0;
    attemptCount=0;
    el.mic.disabled=false;
    el.mic.classList.remove('listening');
    el.mic.setAttribute('aria-label','ãƒã‚¤ã‚¯é–‹å§‹');
    hideAutoNext();
    resetResult();
    resetTranscript();
    primeAudio(QUEUE[i+1]);
    primeAudio(QUEUE[i-1]);
    if(autoPlay&&url){ try{ await audio.play(); }catch(_){ } }
  }

  async function rebuildAndRender(resetIndex=false){ QUEUE=buildQueue(); if(resetIndex) idx=-1; el.pbar.max=Math.max(1, QUEUE.length); el.left.textContent=QUEUE.length; el.next.disabled=false; nextCard(true); }

  function nextCard(first=false, autoPlay=false){ if(!QUEUE.length){ el.footer.textContent='ã‚­ãƒ¥ãƒ¼ãŒç©ºã§ã™'; clearAudioSource(); stopAudio(); return; } idx = first? 0 : Math.min(QUEUE.length-1, idx+1); render(idx, autoPlay); el.pbar.value=idx; el.footer.textContent=`#${idx+1}/${QUEUE.length}`; }
  function prevCard(autoPlay=false){ if(!QUEUE.length) return; idx=Math.max(0, idx-1); render(idx, autoPlay); el.pbar.value=idx; el.footer.textContent=`#${idx+1}/${QUEUE.length}`; }

  // Gestures
  let touchStart=null; const TH=60;
  el.card.addEventListener('touchstart',(ev)=>{ if(ev.touches?.length!==1) return; const t=ev.touches[0]; touchStart={x:t.clientX,y:t.clientY}; },{passive:true});
  el.card.addEventListener('touchend',(ev)=>{ if(!touchStart) return; const end=ev.changedTouches[0]; const dx=end.clientX-touchStart.x, dy=end.clientY-touchStart.y; if(Math.abs(dx)>Math.abs(dy) && Math.abs(dx)>TH){ if(dx>0) prevCard(true); else nextCard(false,true); } else if(Math.abs(dy)>TH && dy<0){ toggleJA(); } touchStart=null; },{passive:true});
  el.en.addEventListener('click', async ()=>{ if(!audio.src) return; try{ if(audio.paused) await audio.play(); else audio.pause(); }catch(_){ } });
  el.en.addEventListener('dblclick', toggleJA);
  el.next.onclick=()=> nextCard(false,true);

  // ASRï¼ˆæ”¹è‰¯ï¼šé‡è¤‡æŠ‘åˆ¶ãƒ»ä¸Šé™ãƒ»å¤šé‡ä¸€è‡´é˜²æ­¢ï¼‰
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recog=null, recogOn=false;
  let stableText=''; // ç¢ºå®šãƒ†ã‚­ã‚¹ãƒˆï¼ˆè©•ä¾¡ã¯ã“ã¡ã‚‰ã®ã¿ä½¿ç”¨ï¼‰

  function matchAndHighlight(refText, hypText){
    // 1) ãƒˆãƒ¼ã‚¯ãƒ³åŒ–
    const refTokens = toks(refText);
    const hypTokensRaw = toks(hypText);
    // 2) é€£ç¶šé‡è¤‡ã‚’åœ§ç¸®
    const hypTokens = dedupeRuns(hypTokensRaw);
    // 3) é•·ã•ä¸Šé™ï¼ˆrefã®2å€ã¾ã§è©•ä¾¡ï¼‰
    const maxLen = Math.max(1, refTokens.length*2);
    const hypCap = hypTokens.slice(0, maxLen);
    // 4) å¤šé‡ä¸€è‡´é˜²æ­¢ï¼ˆè²ªæ¬²ï¼‰ï¼šrefå´ã®æ®‹æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
    const remain = new Map(); for(const w of refTokens) remain.set(w, (remain.get(w)||0)+1);
    let matched=0; const matchedWords=[];
    for(const h of hypCap){
      if(remain.get(h)>0){ remain.set(h, remain.get(h)-1); matched++; matchedWords.push(h); continue; }
      // è¿‘ä¼¼ï¼ˆ<=1ç·¨é›†ï¼‰
      let foundKey=''; for(const [k,c] of remain){ if(c>0){ if(k===h) {foundKey=k; break;} if(Math.abs(k.length-h.length)<=1){
          let i=0,j=0,d=0; while(i<k.length&&j<h.length){ if(k[i]===h[j]){i++;j++;continue;} if(++d>1){ i=h.length; j=k.length; break;} if(k.length>h.length)i++; else if(h.length>k.length)j++; else {i++;j++;} }
          if(d<=1) { foundKey=k; break; }
        }
      } }
      if(foundKey){ remain.set(foundKey, remain.get(foundKey)-1); matched++; matchedWords.push(foundKey); }
    }
    const recall = refTokens.length? matched/refTokens.length : 1;
    const precision = hypCap.length? matched/hypCap.length : 1;
    const missing=[];
    for(const [w,c] of remain){ for(let i=0;i<(c||0);i++) missing.push(w); }

    // ãƒã‚¤ãƒ©ã‚¤ãƒˆé©ç”¨
    const spans=[...document.querySelectorAll('.en .tok')].filter(s=>s.dataset.w);
    for(const sp of spans){ const w=norm(sp.dataset.w); if(!w) continue; let hit = hypCap.includes(w); if(!hit){ hit = hypCap.some(h=>{ if(h===w) return true; if(Math.abs(h.length-w.length)>1) return false; let i=0,j=0,d=0; while(i<w.length&&j<h.length){ if(w[i]===h[j]){i++;j++;continue;} if(++d>1) return false; if(w.length>h.length)i++; else if(h.length>w.length)j++; else {i++;j++;} } return true; }); }
      sp.classList.toggle('hit', !!hit);
      sp.classList.toggle('miss', !hit);
    }
    return {recall, precision, matched: matchedWords, missing };
  }

  function resetTranscript(){ qs('#transcript').innerHTML=''; }
  function showTranscriptInterim(text){ qs('#transcript').innerHTML=`<span class="interim">${text}</span>`; }
  function showTranscriptFinal(text){ qs('#transcript').textContent=text; }

  function startRec(){
    if(!SR){ toast('ã“ã®ç«¯æœ«ã§ã¯éŸ³å£°èªè­˜ãŒä½¿ãˆã¾ã›ã‚“'); return; }
    if(el.mic.disabled) return;
    const shouldResume = audio && !audio.paused;
    recog = new SR();
    recog.lang = 'en-US';
    recog.continuous = true;
    recog.interimResults = true;
    recog.maxAlternatives = 1;

    stableText = '';
    recogOn = true;
    el.asr.textContent = 'éŒ²éŸ³ä¸­â€¦';
    el.mic.classList.add('listening');
    el.mic.setAttribute('aria-label','éŒ²éŸ³åœæ­¢');
    playTone(820,0.1,'sine',0.18);
    updateScore(Number.NaN);
    resetTranscript();

    try{ recog.start(); }catch(_){ }

    if(shouldResume && audio?.src){
      audio.play().catch(()=>{});
    }

    recog.onresult = (ev)=>{
      let interim = '';
      for(let i=ev.resultIndex; i<ev.results.length; i++){
        const r = ev.results[i];
        const t = r[0].transcript || '';
        if(r.isFinal){
          // å°¾éƒ¨ã®ã¿è¿½åŠ ã—ã¦ã„ã
          stableText = appendStableFinal(stableText, t);
          showTranscriptFinal(stableText);
          const m = matchAndHighlight(el.en.textContent, stableText);
          updateScore(m.recall);
        }else{
          interim = t;
        }
      }
      if(interim) showTranscriptInterim(interim); // ç”»é¢è¡¨ç¤ºã ã‘ãƒ»è©•ä¾¡ã«ã¯ä½¿ã‚ãªã„
    };

    recog.onerror = (e)=>{
      recogOn=false;
      el.mic.classList.remove('listening');
      el.mic.setAttribute('aria-label','ãƒã‚¤ã‚¯é–‹å§‹');
      el.asr.textContent = 'ASRã‚¨ãƒ©ãƒ¼';
      console.warn(e);
      toast('ASRã‚¨ãƒ©ãƒ¼: '+(e && e.error || ''));
    };
    recog.onend = ()=>{ if(recogOn) stopRec(); };
  }

  async function stopRec(){
    if(!recogOn) return;
    recogOn=false;
    try{ recog && recog.stop && recog.stop(); }catch(_){ }
    el.mic.classList.remove('listening');
    el.mic.setAttribute('aria-label','ãƒã‚¤ã‚¯é–‹å§‹');
    el.asr.textContent='åˆ¤å®šä¸­â€¦';

    const it = QUEUE[idx]; if(!it) return;
    const hyp = stableText.trim();
    const { recall, precision, matched, missing } = matchAndHighlight(el.en.textContent, hyp);
    attemptCount++;
    const accuracy = recall;
    updateScore(accuracy);
    const pass = accuracy >= 0.70;

    if(pass){
      el.asr.textContent='åˆæ ¼ï¼';
      el.footer.textContent='åˆæ ¼ï¼æ¬¡ã¸é€²ã¿ã¾ã—ã‚‡ã†';
      el.mic.disabled=true;
      el.mic.setAttribute('aria-label','ã“ã®å•é¡Œã¯åˆæ ¼æ¸ˆã¿ã§ã™');
      showAutoNext();
      playTone(1180,0.18,'sine',0.22);
      setTimeout(()=>playTone(1580,0.14,'triangle',0.18),120);
    }else{
      failCount++;
      const remain=Math.max(0,3-failCount);
      if(failCount>=3){
        el.asr.textContent='ä¸åˆæ ¼ï¼šæ¬¡ã¸é€²ã¿ã¾ã™';
        el.footer.textContent='3å›å¤±æ•—ã®ãŸã‚æ¬¡ã¸é€²ã¿ã¾ã™';
        playTone(320,0.25,'square',0.2);
        setTimeout(()=>playTone(220,0.3,'square',0.16),160);
        el.mic.disabled=true;
        el.mic.setAttribute('aria-label','ã“ã®å•é¡Œã¯ä¸åˆæ ¼ã§çµ‚äº†ã—ã¾ã—ãŸ');
        toast('3å›å¤±æ•—ã€‚ä¸åˆæ ¼ã¨ã—ã¦æ¬¡ã¸é€²ã¿ã¾ã™');
        setTimeout(()=>submitEval(0), 450);
      }else{
        el.mic.disabled=false;
        el.asr.textContent=`70%ã‚’ç›®æŒ‡ã—ã¦å†æŒ‘æˆ¦ (${remain}å›æ®‹ã‚Š)`;
        el.footer.textContent='ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã—ã¦ãã ã•ã„';
        playTone(460,0.16,'triangle',0.18);
      }
    }

    const payload = {
      ts: new Date().toISOString(), id: it.id, mode: 'read',
      wer: +(1-recall).toFixed(3), cer: +(1-precision).toFixed(3),
      latency_ms: 0, words_spoken: toks(hyp).length, transcript: hyp,
      matched_tokens_json: JSON.stringify(matched),
      missing_tokens_json: JSON.stringify(missing),
      recall:+recall.toFixed(3), precision:+precision.toFixed(3),
      accuracy:+accuracy.toFixed(3), attempts:attemptCount, fails:failCount
    };
    try{ await sendLog('speech', payload); }catch(_){ }
    recog=null;
  }

  el.mic.onclick=()=>{ if(!recogOn) startRec(); else stopRec(); };
  el.autoNext.onclick=()=>{
    if(el.autoNext.disabled) return;
    el.autoNext.disabled=true;
    nextCard(false,true);
  };
  qsa('[data-eval="ok"]').forEach(b=>b.onclick=()=>submitEval(1));
  qsa('[data-eval="ng"]').forEach(b=>b.onclick=()=>submitEval(0));
  async function submitEval(bin){ const it=QUEUE[idx]; if(!it) return; const payload={ ts:new Date().toISOString(), id:it.id, result:bin, auto_recall:null, auto_precision:null, response_ms:Math.max(0, now()-cardStart), hint_used:(el.ja.style.display==='block'), device:UA }; try{ await sendLog('attempt', payload); }catch(_){ } el.next.disabled=false; nextCard(false,true); }

  // Boot
  (async()=>{
    try{ await ensureDataLoaded(); initSectionPicker(); await ensureDir(); refreshDirStatus(); await rebuildAndRender(true); }catch(e){ console.error(e); toast('åˆæœŸåŒ–å¤±æ•—: '+(e&&e.message||e)); }
  })();
})();
</script>
</body>
</html>
