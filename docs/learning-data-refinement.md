# 学習データ活用とスプレッドシート連携の改善案

## 1. 現状のデータ構造と収集ポイント
- **attempts シート**: モード別の解答時間、ヒント利用、結果(0〜3)を蓄積。失敗や迷いの定量化が可能。
- **speech_metrics シート**: WER/CER、一致率の低い音読結果や発話継続時間など発話品質を記録。
- **sessions シート**: 日別学習量や新出カード数を保存し、習慣化の可視化に活用できる。
- **items / srs_state シート**: 学習コンテンツとSRSの状態管理を想定。発音・理解の弱点を紐付けられる余地がある。

## 2. 音読失敗・一致率低下を活かす優先施策
1. **復習優先度の自動調整**
   - speech_metrics の `wer` / `cer` が閾値(例: WER > 0.3)を超えたカードを `srs_state` にフラグ記録。
   - attempts の `result` が一定回数(例: 0または1が連続3回)のカードも同様にフラグ化。
   - GAS の定期実行トリガーで集計し、srs_state の `last_result` や `ease` を調整して出題優先度を上げる。

2. **弱点リストの自動生成**
   - 新規シート `weak_spots` を作成し、低一致率・連続失敗カードを抽出。
   - カラム例: `id`, `en`, `ja`, `wer_avg`, `recent_attempts`, `last_seen`, `proficiency_level`。
   - Google Apps Script で `exportWeakSpots()` を追加し、クエリ結果を更新。

3. **ヒント表示の二段階化と習熟度別UX**
   - PWA 側のヒント表示を「上スワイプ1回で英文」「2回目で和訳」へ変更し、英文非表示での定着を促進。
   - `attempts` にヒント使用回数を記録している場合は、英文ヒントと和訳ヒントを別カラム化し、習熟度評価に反映。
   - GAS 側の `config` シートでヒント解放条件や回数を管理し、段階的にヒント無しでの音読を促す。

4. **音読フィードバックの可視化**
   - スプレッドシートのチャート・条件付き書式で WER/CER 推移を日別に可視化。
   - 一定期間改善が見られないカードへメモ自動追加(例: "口の形を再確認"など定型コメント)。

## 3. スプレッドシート連携の改善アクション
- **集計ヘルパー関数の追加**: GAS に `getRecentStats(limitDays)` を実装し、最新n日の attempts / speech をまとめて JSON 返却。PWA 側で復習候補を取得しやすくする。
- **バッチ書き込みの最適化**: 同一セッション中の複数計測をまとめて配列でPOSTし `appendRows_` で一括追加することでAPIコールを削減。
- **config シート活用**: 閾値や復習の優先度設定を `config` シートに追加し、GAS から読み取ってダイナミックに閾値調整。

## 4. 運用ワークフロー案
1. **毎晩のトリガー**: `analyzePerformance()` を日次トリガーで実行。低一致率カード抽出・srs_state更新・weak_spots反映。
2. **PWAへのフィードバック**: WebApp.gs の `doGet` に `type=weak_spots` クエリを追加し、PWA から弱点カード一覧を取得。
3. **講師・学習者向けレポート**: Google Slides / Gmail 連携で週次レポートを自動送信。音読改善率や苦手項目を記載。

## 5. 習熟度レベル設計と運用方針

音読の一致率とヒント利用状況を元に、学習者の習熟度を以下の5段階で評価する。

- **Lv1**: 一致率70%以下。英文ヒントや和訳を活用しながら再挑戦を促す。
- **Lv2**: 一致率70%以上。英文提示での音読成功を継続させる段階。
- **Lv3**: 一致率90%以上。まずは全カードをこのレベルへ到達させることを優先目標とする。
- **Lv4**: 英文非表示のまま一致率90%以上。ヒントを段階的に制限し、英文想起力を強化。
- **Lv5**: 英文非表示のまま一致率100%。目標必須ではないが、上級者向けチャレンジとする。

### レベル活用の具体施策

1. `srs_state` に `proficiency_level` フィールドを追加し、GAS の日次バッチで最新一致率・ヒント利用から再計算。
2. `weak_spots` シートでは Lv1/Lv2 のカードを優先抽出し、PWA の復習キューに反映。Lv3 到達カードは通知で達成感を提供。
3. Lv4 への移行は `config` シートに設定した達成率(例: 全体の60%がLv3以上)を満たしたタイミングで、ヒント表示をデフォルト非表示に切り替える。
4. Lv5 向けの特別モードは希望者のみ利用できるようにし、過度なプレッシャーを避ける。

## 6. 苦手単語データの蓄積と集中特訓

音声認識APIが返す語単位の一致結果や、attempts の回答ログから抽出した不一致語を蓄積し、単語別に弱点管理を行う。

- **データ構造**: 新規シート `word_difficulties` を作成し、`word`, `item_id`, `mispronounce_count`, `last_seen`, `proficiency_level` を記録。
- **集計ロジック**: GAS で `aggregateWordDifficulty()` を実装し、音声認識ログの `word_confidence < threshold` などの条件でカウントを増やす。
- **PWA 連携**: 単語単位の特訓モードを追加し、苦手単語のみをまとめて音読・スペリング練習できるようにする。
- **学習設計**: 通常のカード復習とは独立した「単語集中セッション」を設定し、短時間で弱点語彙を克服できるフローを構築する。

これにより、カード単位の習熟度と単語単位の課題を両輪で管理し、学習効果の最大化を図る。

## 7. 今後の拡張検討
- **音声認識ログの粒度向上**: 語彙単位の誤り箇所を保存し、部分的リピート練習を提案。
- **タグ活用**: items の `tags` で文法/トピック分類し、特定タグの弱点集約。
- **デバイス別分析**: attempts の `device` から、PC/モバイル環境差による失敗率を分析。
- **学習モード別 KPI**: `mode` ごとの平均反応時間や成功率をダッシュボード化し、教材改善に活用。

## 8. 実装ロードマップ例
| フェーズ | タスク | 目的 |
| --- | --- | --- |
| 1 | config 閾値追加 + analyzePerformance 下書き | 復習優先度の自動化土台を作る |
| 2 | weak_spots シート生成 + doGet API拡張 | PWA へ弱点カードを供給 |
| 3 | ダッシュボード/通知連携 | 学習者・講師へのフィードバック強化 |

これらを段階的に導入することで、音読失敗や一致率低下といった学習データを即座に復習計画へ反映させ、効率的な定着につなげることができます。
